---
import '../styles/global.css';
import Online from '../components/online.astro';
import DashLayout from '../layouts/Login.astro';
import NavBar from '../components/nav-bar.astro';
import CardVentas from '../components/cards-ventas.astro';
import ErrorVentas from '../components/error-ventas.astro';
import VentasEmpty from '../components/ventas-empty.astro';
import Footer from '../components/footer.astro';
import HeaderTop from '../components/header-top.astro';

interface VentasK {
  m: string;
  ventas: {
    id: number;
    cantidad: number;
    cod_suc: number;
    fecha: string;
    gtotal: number;
    impuesto: number;
    promedio: number;
    sucursal: number;
    total: number;
  }[];
}

interface Totales {
  r_total: number;
  r_gtotal: number;
  r_impuesto: number;
  r_ticket: number;
}

const base_url: string = 'URL/';
let error_has: boolean = false;
let data: VentasK | null = null;
let totales: Totales = {
  r_total: 0,
  r_gtotal: 0,
  r_impuesto: 0,
  r_ticket: 0
};

const ventasy_fectch = await fetch(
    `${base_url}/y`,
    {
        method: 'GET',
        headers: {
        'Content-Type': 'application/json'
        },
        credentials: 'include',
    },
);

if (ventasy_fectch.ok){
  data = await ventasy_fectch.json() as VentasK;
  if (data.ventas){
    totales = data.ventas.reduce((current, val) => {
      current = {
        r_total: current.r_total + val.total,
        r_gtotal: current.r_gtotal + val.gtotal,
        r_impuesto: current.r_impuesto + val.impuesto,
        r_ticket: current.r_ticket + val.cantidad,
      }
      return current;
    }, {
      r_total: 0,
      r_gtotal: 0,
      r_impuesto: 0,
      r_ticket: 0
    });
  }
}else{
  
  error_has = true;
}
---

<Online></Online>
<DashLayout>
    
    <NavBar></NavBar>
    <HeaderTop 
      r_total={totales.r_total.toFixed(2)},
      r_gtotal={totales.r_gtotal.toFixed(2)},
      r_impuesto={totales.r_impuesto.toFixed(2)},
      r_ticket={totales.r_total.toFixed(0)} >
    </HeaderTop>
    <main class="max-w-7xl mx-auto p-6 md:p-10 space-y-12">
      <section class="flex justify-start">
        <div class="w-full max-w-sm">
          <form class="search-filter-form" id="searchbydate">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3 block">
              Filtrar por fecha
            </label>
            <div class="search-input-group">
              <div class="search-icon">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <input 
                type="date"
                name="date"
                class="search-input-field"
              />
              <button type="submit" class="search-submit-btn">
                Buscar
              </button>
            </div>
          </form>
        </div>
      </section>
      <section class="space-y-8">
        <div class="flex items-center justify-between border-b border-slate-200 pb-4">
            <h2 class="text-sm font-black text-slate-500 uppercase tracking-[0.2em]">
              Consolidado de Sucursales
              <span class="text-xs text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded-full" id="text-consolidado"></span>
            </h2>
            <span class="text-xs text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded-full">Maraplus</span>
        </div>
        {
          !error_has && data !== null
            ?
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="cards-ventas">
              {data.ventas.length > 0 ? data.ventas.sort((a, b) => b.total - a.total).map((va, i) => (
                <CardVentas 
                  index={i+1}
                  cod_suc={va.cod_suc} 
                  sucursal={va.sucursal}
                  animation={i}
                  total={va.total}
                  gtotal={va.gtotal}
                  impuesto={va.impuesto}
                  ticket={va.cantidad} ></CardVentas>
              )) : (
                <VentasEmpty></VentasEmpty>
              )}
            </div>
            : (
              <ErrorVentas></ErrorVentas>
            )
        }
      </section>
    </main>
    <Footer></Footer>
  </body>
</DashLayout>

<style is:global>
  .search-filter-form {
    position: relative;
    width: 100%;
  }
  .search-input-group {
    display: flex;
    align-items: center;
    background: #ffffff;
    border: 1.5px solid #7d7d7d62;
    padding: 0.4rem;
    border-radius: 1.25rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .search-input-group:focus-within {
    border-color: #155dfb;
    box-shadow: 0 10px 25px -10px rgba(21, 93, 251, 0.15);
    transform: translateY(-2px);
  }
  .search-icon {
    padding-left: 1rem;
    padding-right: 0.5rem;
    color: #94a3b8;
  }
  .search-input-field {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 0.85rem;
    font-weight: 600;
    color: #0f172a;
    outline: none;
    padding: 0.5rem 0;
  }
  .search-input-field::placeholder {
    color: #cbd5e1;
    font-weight: 500;
  }
  .search-submit-btn {
    background: #155dfb;
    color: white;
    font-size: 0.7rem;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 0.7rem 1.2rem;
    border-radius: 0.85rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .search-submit-btn:hover {
    background: #0d4ed8;
    box-shadow: 0 4px 12px rgba(21, 93, 251, 0.3);
  }
  .search-submit-btn:active {
    transform: scale(0.95);
  }
</style>

<script>
  const searchbydate = document.getElementById('searchbydate') as HTMLFormElement;
  if (searchbydate !== null){
    const cardas_parents = document.getElementById('cards-ventas');
    const cardds_totales = document.getElementById('cards_totales');
    const title_consolidado = document.getElementById('text-consolidado')
    
    searchbydate.addEventListener('submit', async (e) =>{
      e.preventDefault();

      const formData_searchdate = new FormData(searchbydate);
      const fecha = Object.fromEntries(formData_searchdate.entries()) as { date: string };
      if ('date' in fecha){

        title_consolidado ? title_consolidado.innerText = `${fecha.date ?? ''}` : title_consolidado;
        try {
          const ventasy_fectch = await fetch(
              `URL/${fecha.date ?? ''}`,
              {
                  method: 'GET',
                  headers: {
                  'Content-Type': 'application/json'
                  },
                  credentials: 'include',
              },
          );
          
          if (ventasy_fectch.status === 401)  window.location.href = '/';
          const data = await ventasy_fectch.json() as {
            m: string;
            ventas: {
              id: number;
              cantidad: number;
              cod_suc: number;
              fecha: string;
              gtotal: number;
              impuesto: number;
              promedio: number;
              sucursal: number;
              total: number;
            }[];
          };

          const ranking = data.ventas.sort((a, b) => b.total - a.total);
          const totales = ranking.reduce((current, val) => {
              current = {
                r_total: current.r_total + val.total,
                r_gtotal: current.r_gtotal + val.gtotal,
                r_impuesto: current.r_impuesto + val.impuesto,
                r_ticket: current.r_ticket + val.cantidad,
              }
              return current;
            }, {
              r_total: 0,
              r_gtotal: 0,
              r_impuesto: 0,
              r_ticket: 0
            });
          if (cardas_parents && cardds_totales){

            const htmlCardsTotales = `
              <div class="metric-box border-b lg:border-b-0 lg:border-r border-slate-100">
                  <p class="metric-label">Totales</p>
                  <div class="flex items-center gap-2">
                      <span class="metric-value-compact">
                        ${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(totales.r_gtotal)}
                      </span>
                      <span class="text-green-900">↑</span>
                  </div>
              </div>

              <div class="metric-box border-b lg:border-b-0 lg:border-r border-slate-100">
                  <p class="metric-label">Subtotales</p>
                  <div class="flex items-center gap-2">
                      <span class="metric-value-compact">
                        ${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(totales.r_total)}
                        </span>
                      <span class="text-green-900">↑</span>
                  </div>
              </div>

              <div class="metric-box border-b lg:border-b-0 lg:border-r border-slate-100">
                  <p class="metric-label">Impuesto Total</p>
                  <div class="flex items-center gap-2">
                      <span class="metric-value-compact">${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(totales.r_impuesto)}</span>
                      <span class="text-red-900 rotate-180">↑</span>
                  </div>
              </div>

              <div class="metric-box">
                  <p class="metric-label">Tickets Totales</p>
                  <span class="metric-value-compact">#${totales.r_ticket.toFixed(0)}</span>
              </div>
            `;
            const htmlcardasVentas = ranking.length > 0 
              ? 
              ranking.map((c, i) => `
              <div class="card-container" id="card-container" style={'animation-delay: ${i * 100}ms'}>
                <div class="card-professional" id="card-professional">

                  <span class="ranking-number">#${i+1}</span>
                  <div class="flex items-center gap-3 mb-6 relative z-10">
                    <div class="icon-box w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-blue-600 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        </div>
                        <div>
                        <p class="text-[10px] font-bold text-slate-700 uppercase tracking-tighter">${c.cod_suc}</p>
                        <h3 class="text-base font-bold text-slate-800 tracking-tight">${c.sucursal}</h3>
                        </div>
                    </div>

                    <div class="space-y-2 mb-6 text-sm">
                        <div class="flex justify-between"><span class="text-slate-700">Ticket</span><span class="font-semibold text-slate-400">${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(c.cantidad)}</span></div>
                        <div class="flex justify-between"><span class="text-slate-700">Total</span><span class="font-semibold text-slate-700">${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(c.gtotal)}</span></div>
                        <div class="flex justify-between"><span class="text-slate-700">Subtotal</span><span class="font-semibold text-slate-700">${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(c.total)}</span></div>
                        <div class="flex justify-between"><span class="text-slate-700">Impuestos</span><span class="font-semibold text-slate-400">${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(c.impuesto)}</span></div>
                    </div>

                    <div class="mt-auto pt-4 border-t border-slate-50 flex justify-between items-end">
                        <div>
                        <p class="text-[9px] font-black text-blue-600 uppercase mb-1">Total Neto</p>
                        <p class="text-2xl font-black text-slate-900 leading-none">${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(c.gtotal)}</p>
                        </div>
                    </div>
                  </div>
              </div>`).join('') 
              : `
                <div class="col-span-full flex justify-center items-center py-20 px-4">
                  <div class="no-results-wrapper">
                  
                  <div class="no-results-icon-box">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                      </svg>
                  </div>

                  <div class="text-center space-y-3">
                      <h3 class="text-2xl font-black text-slate-900 tracking-tight">Sin Ventas Registradas</h3>
                      <p class="text-slate-600 text-sm font-medium max-w-sm mx-auto leading-relaxed">
                      No se encontró efectividad POS en este periodo. Intenta ajustar los filtros de fecha para obtener resultados.
                      </p>
                  </div>
                  </div>
              </div>
              `;
            cardas_parents.innerHTML = htmlcardasVentas;
            cardds_totales.innerHTML = htmlCardsTotales;
          }
        } catch (error) {
          if (cardas_parents) cardas_parents.innerHTML = `
            <div class="col-span-full flex justify-center items-center py-20 px-4">
              <div class="error-status-card">
                  <div class="error-icon-box">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                      </svg>
                  </div>

                  <div class="text-center space-y-3">
                      <h3 class="text-2xl font-black text-red-600 tracking-tight">Error de Conexión</h3>
                      <p class="text-slate-500 text-sm font-medium max-w-sm mx-auto leading-relaxed">
                          Ha ocurrido un problema técnico al intentar cargar los datos. Por favor, verifica tu conexión o intenta refrescar el panel.
                      </p>
                  </div>

                  <div class="flex justify-center pt-8">
                      <button 
                          onclick="window.location.reload()" 
                          class="error-action-badge font-bold text-white bg-[#155dfb] p-3 rounded-2xl cursor-pointer">
                          <span class="error-dot-blink"></span>
                          Reintentar Carga de Datos
                      </button>
                  </div>
              </div>
          </div>
          `
        }
      }
    });
  }

</script>